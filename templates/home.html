{% extends 'base.html' %}

{% block extra_head %}
<style>
  body {
    display: flex;
    font-family: Arial, sans-serif;
  }

  #left-panel {
    width: 60%;
    padding: 20px;
  }

  #right-panel {
    width: 40%;
    padding: 20px;
  }

  video {
    width: 100%;
    height: auto;
  }

  textarea {
    width: 100%;
    height: 200px;
  }

  .timestamp {
    margin-bottom: 10px;
  }

  .drop-zone {
    width: 100%;
    max-width: 600px;
    height: 300px;
    border: 2px dashed #ccc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    margin: 20px auto;
    font-family: Arial, sans-serif;
    color: #333;
  }

  .drop-zone.hover {
    border-color: #000;
  }

  .drop-zone p {
    pointer-events: none;
  }
</style>
{% endblock %}

{% block title %}Home - MyApp{% endblock %}

{% block content %}
<div id="left-panel">
  <div class="drop-zone" id="drop-zone">
    <p>Drag & Drop your video file here</p>
  </div>
  <br><br>
  <video id="video" controls hidden></video>
  <br><br>
  <div id="script">
    <h3>Script</h3>
    <textarea id="script-text" readonly></textarea>
  </div>
</div>
<div id="right-panel">
  <h3>Subtitles</h3>
  <div id="subtitles">
    <div class="timestamp">
      <label for="timestamp1">00:00:01</label>
      <textarea id="timestamp1">Hello, Julia.</textarea>
    </div>
    <div class="timestamp">
      <label for="timestamp2">00:00:05</label>
      <textarea id="timestamp2">While filming today, I misspoke a few lines.</textarea>
    </div>
    <!-- More timestamps and textareas as needed -->
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  const dropZone = document.getElementById('drop-zone');
  const videoElement = document.getElementById('video');
  const scriptElement = document.getElementById('script');
  const scriptTextElement = document.getElementById('script-text');
  const subtitlesElement = document.getElementById('subtitles');

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('hover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('hover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('hover');
    const files = e.dataTransfer.files;
    handleFiles(files);
  });

  function handleFiles(files) {
    for (const file of files) {
      if (file.type.startsWith('video/')) {
        uploadFile(file);
      } else {
        alert('Please upload a valid video file.');
      }
    }
  }

  function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    axios.post('{% url "caption:make-caption" %}', formData, {
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'multipart/form-data'
      }
    })
    .then(response => {
      scriptTextElement.textContent = response.data;
      dropZone.style.display = 'none';
      videoElement.hidden = false;
      videoElement.src = URL.createObjectURL(file);
      fetchSubtitles('/uploads/' + file.name.split('.')[0] + '.srt');
    })
    .catch(error => {
      alert('An error occurred while uploading the file.');
    });
  }

  function fetchSubtitles(subtitleFileUrl) {
    axios.get(subtitleFileUrl)
      .then(response => {
        const subtitles = parseSubtitles(response.data);
        displaySubtitles(subtitles);
      })
      .catch(error => {
        alert('An error occurred while fetching the subtitles.');
      });
  }

  function parseSubtitles(data) {
    const subtitles = [];
    const lines = data.split('\n');
    let timestamp = '';
    let text = '';

    lines.forEach(line => {
      if (line.includes('-->')) {
        if (timestamp && text) {
          subtitles.push({ timestamp, text });
        }
        timestamp = line;
        text = '';
      } else {
        text += line + '\n';
      }
    });

    if (timestamp && text) {
      subtitles.push({ timestamp, text });
    }

    return subtitles;
  }

  function displaySubtitles(subtitles) {
    subtitlesElement.innerHTML = '';
    subtitles.forEach((subtitle, index) => {
      const div = document.createElement('div');
      div.className = 'timestamp';
      const label = document.createElement('label');
      label.setAttribute('for', `timestamp${index}`);
      label.textContent = subtitle.timestamp;
      const textarea = document.createElement('textarea');
      textarea.id = `timestamp${index}`;
      textarea.textContent = subtitle.text.trim();
      div.appendChild(label);
      div.appendChild(textarea);
      subtitlesElement.appendChild(div);
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Example script data (normally this would come from a backend service)
  const scriptText = `Hello, Julia.
  While filming today, I misspoke a few lines.
  I need to reintroduce myself separately.
  Finally, I wish to apologize for any confusion.`;

  document.getElementById('script-text').textContent = scriptText;

  // TODO: Add functionality to edit subtitles and save changes
</script>
{% endblock %}