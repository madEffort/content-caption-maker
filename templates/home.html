{% extends 'base.html' %}

{% block extra_head %}
<style>
  body {
    display: flex;
    font-family: Arial, sans-serif;
  }

  #left-panel {
    width: 60%;
    padding: 20px;
  }

  #right-panel {
    width: 40%;
    padding: 20px;
  }

  video {
    width: 100%;
    height: auto;
  }

  textarea {
    width: 100%;
    height: 200px;
  }

  .timestamp {
    margin-bottom: 10px;
  }

  .drop-zone {
    width: 100%;
    max-width: 600px;
    height: 300px;
    border: 2px dashed #ccc;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    margin: 20px auto;
    font-family: Arial, sans-serif;
    color: #333;
  }

  .drop-zone.hover {
    border-color: #000;
  }

  .drop-zone p {
    pointer-events: none;
  }

  .progress-bar-container {
    width: 100%;
    max-width: 600px;
    height: 30px;
    border: 1px solid #ccc;
    border-radius: 10px;
    overflow: hidden;
    margin: 20px auto;
    display: none;
  }

  .progress-bar {
    height: 100%;
    width: 0;
    background-color: #4caf50;
    transition: width 0.1s;
  }

</style>
{% endblock %}

{% block title %}Home - MyApp{% endblock %}

{% block content %}
<div id="left-panel">
  <div class="drop-zone" id="drop-zone">
    <p>Drag & Drop your video file here</p>
  </div>
  <div class="progress-bar-container" id="progress-bar-container">
    <div class="progress-bar" id="progress-bar"></div>
  </div>
  <br><br>
  <video id="video" controls hidden></video>
  <br><br>
  <div id="script">
    <h3>Script</h3>
    <textarea id="script-text" readonly></textarea>
  </div>
</div>
<div id="right-panel">
  <h3>Subtitles</h3>
  <div id="subtitles">
    <div class="timestamp">
      <label for="timestamp1">00:00:01</label>
      <textarea id="timestamp1">Hello, Julia.</textarea>
    </div>
    <div class="timestamp">
      <label for="timestamp2">00:00:05</label>
      <textarea id="timestamp2">While filming today, I misspoke a few lines.</textarea>
    </div>
    <!-- More timestamps and textareas as needed -->
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  const dropZone = document.getElementById('drop-zone');
  const videoElement = document.getElementById('video');
  const scriptElement = document.getElementById('script');
  const scriptTextElement = document.getElementById('script-text');
  const subtitlesElement = document.getElementById('subtitles');
  const progressBarContainer = document.getElementById('progress-bar-container');
  const progressBar = document.getElementById('progress-bar');

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('hover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('hover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('hover');
    const files = e.dataTransfer.files;
    handleFiles(files);
  });

  function handleFiles(files) {
    for (const file of files) {
      if (file.type.startsWith('video/')) {
        uploadFile(file);
      } else {
        alert('Please upload a valid video file.');
      }
    }
  }

  function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);

    const xhr = new XMLHttpRequest();
    xhr.open('POST', '{% url "caption:transcribe_video" %}', true);

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const percentComplete = (e.loaded / e.total) * 100;
        progressBar.style.width = percentComplete + '%';
      }
    };

    xhr.onloadstart = () => {
      progressBarContainer.style.display = 'block';
      progressBar.style.width = '0%';
    };

    xhr.onload = () => {
      if (xhr.status === 200) {
        const data = JSON.parse(xhr.responseText);
        if (data.error) {
          alert(data.error);
        } else {
          videoElement.src = data.video_url;
          videoElement.hidden = false;
          dropZone.style.display = 'none';
          scriptElement.hidden = false;
          scriptTextElement.textContent = data.transcribed_text;
          progressBarContainer.style.display = 'none';
          // TODO: Parse and display subtitles in #subtitles element
        }
      } else {
        alert('An error occurred during the upload. Please try again.');
      }
    };

    xhr.onerror = () => {
      alert('An error occurred during the upload. Please try again.');
    };

    // Include CSRF token in the request
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

    xhr.send(formData);
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Example script data (normally this would come from a backend service)
  const scriptText = `Hello, Julia.
  While filming today, I misspoke a few lines.
  I need to reintroduce myself separately.
  Finally, I wish to apologize for any confusion.`;

  document.getElementById('script-text').textContent = scriptText;

  // TODO: Add functionality to edit subtitles and save changes
</script>
{% endblock %}